# =============================================================================
# Analytical-Intelligence v1 - Analysis Server Stack
# Runs on the analysis machine
# =============================================================================
#
# The backend listens on 0.0.0.0:8000 so it's accessible from:
#   - Sensor servers (for ingestion API)
#   - Your Windows machine (for Dashboard UI)
#
# REQUIRED environment variables (set in .env):
#   INGEST_API_KEY  - API key for authenticating sensor agents
#
# OPTIONAL environment variables:
#   POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB - Database credentials
#
# =============================================================================

services:
  # ─────────────────────────────────────────────────────────────────────────
  # PostgreSQL Database
  # ─────────────────────────────────────────────────────────────────────────
  postgres:
    image: postgres:15-alpine
    container_name: ai_db-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-ai}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ai2025}
      POSTGRES_DB: ${POSTGRES_DB:-ai_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/init_db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - ai-network
    # PostgreSQL is NOT exposed externally - only backend can access it

  # ─────────────────────────────────────────────────────────────────────────
  # Backend API + UI (FastAPI)
  # ─────────────────────────────────────────────────────────────────────────
  backend:
    build:
      context: ./services/backend
      dockerfile: Dockerfile
    container_name: ai_db-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database connection (uses container name 'postgres')
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-ai}:${POSTGRES_PASSWORD:-ai2025}@postgres:5432/${POSTGRES_DB:-ai_db}
      # API key for ingestion endpoints
      INGEST_API_KEY: ${INGEST_API_KEY:?error - set INGEST_API_KEY in .env}
      # Backend host binds to all interfaces
      BACKEND_HOST: "0.0.0.0"
      BACKEND_PORT: "8000"
      # Model paths (inside container) - RF model
      SSH_MODEL_PATH: /app/models/ssh/ssh_lstm.joblib
      NETWORK_MODEL_PATH: /app/models/RF/random_forest.joblib
      NETWORK_FEATURES_PATH: /app/models/RF/feature_list.json
      NETWORK_LABELS_PATH: /app/models/RF/label_map.json
      NETWORK_PREPROCESS_PATH: /app/models/RF/preprocess_config.json
      # ─────────────────────────────────────────────────────────────────────
      # Network ML Tuning for Reliable Detection
      # ─────────────────────────────────────────────────────────────────────
      NETWORK_ML_THRESHOLD: "0.60"
      NETWORK_ML_DISABLE_GATING: "1"
      NETWORK_ML_DISABLE_KNOWN_LABEL_CHECK: "1"
      NETWORK_ML_LABEL_THRESHOLDS_JSON: '{"DoS":0.55,"DDoS":0.60,"Port Scanning":0.50,"Brute Force":0.60}'
      NETWORK_ML_DEBUG: "0"
      NETWORK_ML_DEBUG_SAMPLE_RATE: "50"
      # Dedup/cooldown for ~6s detection cadence
      ML_DEDUP_WINDOW_SECONDS: "10"
      ML_COOLDOWN_SECONDS_PER_SRC: "0"
      # ─────────────────────────────────────────────────────────────────────
      # Telegram Alerts (Optional) - Safe defaults, disabled unless configured
      # ─────────────────────────────────────────────────────────────────────
      TELEGRAM_ENABLED: ${TELEGRAM_ENABLED:-false}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:--5228638760}
      TELEGRAM_MIN_SEVERITY: ${TELEGRAM_MIN_SEVERITY:-HIGH}
      TELEGRAM_RATE_LIMIT_PER_MIN: ${TELEGRAM_RATE_LIMIT_PER_MIN:-20}
      TELEGRAM_DEDUP_WINDOW_SECONDS: ${TELEGRAM_DEDUP_WINDOW_SECONDS:-60}
      TELEGRAM_TIMEOUT_SECONDS: ${TELEGRAM_TIMEOUT_SECONDS:-10}
      TELEGRAM_STARTUP_TEST: ${TELEGRAM_STARTUP_TEST:-false}
      PUBLIC_DASHBOARD_BASE_URL: ${PUBLIC_DASHBOARD_BASE_URL:-}
    volumes:
      - ./models:/app/models:ro
      - ./models/ssh:/app/models/ssh:ro
      - ./models/RF:/app/models/RF:ro
    ports:
      # Expose to all interfaces so Windows can access via LAN IP
      - "8000:8000"
    networks:
      - ai-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/api/v1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  ai-network:
    driver: bridge

volumes:
  postgres_data:
