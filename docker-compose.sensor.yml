
# =============================================================================
# Analytical-Intelligence v1 - Sensor Server Stack
# Runs on the sensor machine 
# =============================================================================
#
# REQUIRED environment variables (set in .env):
#   ANALYZER_HOST   - IP or hostname of Analysis server 
#   INGEST_API_KEY  - API key matching Analysis server's INGEST_API_KEY
#   DEVICE_ID       - Unique identifier for this sensor (e.g., sensor-01)
#   HOSTNAME        - Human-readable hostname
#
# OPTIONAL environment variables:
#   NET_IFACE       - Network interface for capture (default: ens33)
#   DEVICE_IP       - Override auto-detected device IP
#   ANALYZER_PORT   - Analysis server port (default: 8000)
#
# =============================================================================

services:
  # ─────────────────────────────────────────────────────────────────────────
  # Auth Log Collector - Monitors /var/log/auth.log for SSH events
  # ─────────────────────────────────────────────────────────────────────────
  auth_collector:
    build:
      context: ./agents/auth_collector
      dockerfile: Dockerfile
    container_name: ai_db-auth-collector
    restart: unless-stopped
    network_mode: host
    environment:
      # Required - will error if not set
      ANALYZER_HOST: ${ANALYZER_HOST:?error - set ANALYZER_HOST in .env}
      INGEST_API_KEY: ${INGEST_API_KEY:?error - set INGEST_API_KEY in .env}
      DEVICE_ID: ${DEVICE_ID:?error - set DEVICE_ID in .env}
      HOSTNAME: ${HOSTNAME:?error - set HOSTNAME in .env}
      # Optional with defaults
      NET_IFACE: ${NET_IFACE:-ens33}
      ANALYZER_PORT: ${ANALYZER_PORT:-8000}
      # Optional override (leave empty for auto-detect)
      DEVICE_IP: ${DEVICE_IP:-}
    volumes:
      - /var/log/auth.log:/var/log/auth.log:ro
      - ./agents/common:/app/common:ro

  # ─────────────────────────────────────────────────────────────────────────
  # Flow Collector - Captures network flows with NFStream
  # ─────────────────────────────────────────────────────────────────────────
  flow_collector:
    build:
      context: ./agents/flow_collector
      dockerfile: Dockerfile
    container_name: ai_db-flow-collector
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    security_opt:
      - apparmor=unconfined
    environment:
      # Required - will error if not set
      ANALYZER_HOST: ${ANALYZER_HOST:?error - set ANALYZER_HOST in .env}
      INGEST_API_KEY: ${INGEST_API_KEY:?error - set INGEST_API_KEY in .env}
      DEVICE_ID: ${DEVICE_ID:?error - set DEVICE_ID in .env}
      HOSTNAME: ${HOSTNAME:?error - set HOSTNAME in .env}
      # Optional with defaults
      NET_IFACE: ${NET_IFACE:-ens33}
      ANALYZER_PORT: ${ANALYZER_PORT:-8000}
      # Optional override (leave empty for auto-detect)
      DEVICE_IP: ${DEVICE_IP:-}
      # Flow timeouts for ~6s detection cadence
      FLOW_IDLE_TIMEOUT: ${FLOW_IDLE_TIMEOUT:-6}
      FLOW_ACTIVE_TIMEOUT: ${FLOW_ACTIVE_TIMEOUT:-6}
    volumes:
      - ./agents/common:/app/common:ro
