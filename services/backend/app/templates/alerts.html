{% extends "base.html" %}

{% block content %}
<div class="page-content">
    <div class="page-header">
        <h1>ðŸš¨ Security Alerts</h1>
        <p class="subtitle">All detections from Suricata IDS, SSH LSTM, and Network ML models</p>
    </div>

    <!-- Filters -->
    <div class="filters-card">
        <form method="get" class="filters-form">
            <div class="filter-group">
                <label for="severity">Severity</label>
                <select name="severity" id="severity">
                    <option value="">All</option>
                    <option value="CRITICAL" {% if filters.severity=='CRITICAL' %}selected{% endif %}>CRITICAL</option>
                    <option value="HIGH" {% if filters.severity=='HIGH' %}selected{% endif %}>HIGH</option>
                    <option value="MEDIUM" {% if filters.severity=='MEDIUM' %}selected{% endif %}>MEDIUM</option>
                    <option value="LOW" {% if filters.severity=='LOW' %}selected{% endif %}>LOW</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="model_name">Model</label>
                <select name="model_name" id="model_name">
                    <option value="">All</option>
                    <option value="suricata" {% if filters.model_name=='suricata' %}selected{% endif %}>Suricata
                    </option>
                    <option value="ssh_lstm" {% if filters.model_name=='ssh_lstm' %}selected{% endif %}>SSH LSTM
                    </option>
                    <option value="network_ml" {% if filters.model_name=='network_ml' %}selected{% endif %}>Network ML
                    </option>
                </select>
            </div>
            <div class="filter-group">
                <label for="label">Label Contains</label>
                <input type="text" name="label" id="label" value="{{ filters.label or '' }}"
                    placeholder="e.g., SSH, DoS">
            </div>
            <div class="filter-group">
                <label for="last_minutes">Time Range</label>
                <select name="last_minutes" id="last_minutes">
                    <option value="">All Time</option>
                    <option value="5" {% if filters.last_minutes==5 %}selected{% endif %}>Last 5 min</option>
                    <option value="15" {% if filters.last_minutes==15 %}selected{% endif %}>Last 15 min</option>
                    <option value="60" {% if filters.last_minutes==60 %}selected{% endif %}>Last 1 hour</option>
                    <option value="1440" {% if filters.last_minutes==1440 %}selected{% endif %}>Last 24 hours</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Apply Filters</button>
            <a href="/alerts" class="btn btn-secondary">Clear</a>
        </form>
    </div>

    <!-- Results Count -->
    <div class="results-info">
        <span>Showing {{ detections|length }} alerts</span>
    </div>

    <!-- Alerts Table -->
    <div class="section-card">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Timestamp</th>
                    <th>Severity</th>
                    <th>Model</th>
                    <th>Label</th>
                    <th>Device</th>
                    <th>Score</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for d in detections %}
                <tr class="severity-row-{{ d.severity|lower }}">
                    <td>{{ d.id }}</td>
                    <td class="timestamp">{{ d.ts[:19] }}</td>
                    <td><span class="severity-badge {{ d.severity|lower }}">{{ d.severity }}</span></td>
                    <td><span class="model-badge {{ d.model_name }}">{{ d.model_name }}</span></td>
                    <td class="label-cell" title="{{ d.label }}">{{ d.label[:60] }}{% if d.label|length > 60 %}...{%
                        endif %}</td>
                    <td>{{ d.device_id }}</td>
                    <td>{{ "%.2f"|format(d.score) }}</td>
                    <td>
                        <button class="btn btn-sm btn-info" data-details="{{ d.details|tojson|e }}"
                            onclick="showDetails(this.dataset.details)">View</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="empty-state">No alerts found matching the filters</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Details Modal -->
<div id="details-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h3>Alert Details</h3>
        <pre id="details-json"></pre>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    function showDetails(detailsJson) {
        const details = JSON.parse(detailsJson);
        document.getElementById('details-json').textContent = JSON.stringify(details, null, 2);
        document.getElementById('details-modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('details-modal').style.display = 'none';
    }

    window.onclick = function (event) {
        const modal = document.getElementById('details-modal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    }
</script>
{% endblock %}