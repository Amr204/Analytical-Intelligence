{% extends "base.html" %}

{% block content %}
<div class="dashboard">
    <h1>Security Dashboard</h1>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <span class="stat-value" id="total-events">{{ stats.total_events }}</span>
                <span class="stat-label">Total Events</span>
            </div>
        </div>
        <div class="stat-card alert-card">
            <div class="stat-icon">üö®</div>
            <div class="stat-content">
                <span class="stat-value" id="total-detections">{{ stats.total_detections }}</span>
                <span class="stat-label">Total Detections</span>
            </div>
        </div>
        <div class="stat-card warning-card">
            <div class="stat-icon">‚è∞</div>
            <div class="stat-content">
                <span class="stat-value" id="detections-24h">{{ stats.detections_24h }}</span>
                <span class="stat-label">Detections (24h)</span>
            </div>
        </div>
        <div class="stat-card info-card">
            <div class="stat-icon">üñ•Ô∏è</div>
            <div class="stat-content">
                <span class="stat-value" id="total-devices">{{ stats.total_devices }}</span>
                <span class="stat-label">Devices</span>
            </div>
        </div>
    </div>

    <!-- Severity Breakdown -->
    <div class="section-row">
        <div class="section-card">
            <h2>Detections by Severity</h2>
            <div class="severity-bars">
                {% set severity_colors = {'CRITICAL': 'critical', 'HIGH': 'high', 'MEDIUM': 'medium', 'LOW': 'low'} %}
                {% set severity_order = ['CRITICAL','HIGH','MEDIUM','LOW'] %}
                {% set total = stats.total_detections or 1 %}

                {% for sev in severity_order %}
                {% set count = stats.detections_by_severity.get(sev, 0) %}
                {% set pct = ((count / total) * 100) | round(2) %}

                <div class="severity-row">
                    <span class="severity-badge {{ severity_colors.get(sev, 'low') }}">{{ sev }}</span>
                    <div class="severity-bar-container">
                        <div class="severity-bar {{ severity_colors.get(sev, 'low') }}" data-width="{{ pct }}"
                            aria-label="{{ sev }}: {{ pct }} percent"></div>
                    </div>
                    <span class="severity-count">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>


        <div class="section-card">
            <h2>Events by Type</h2>
            <div class="type-breakdown">
                {% for event_type, count in stats.events_by_type.items() %}
                <div class="type-item">
                    <span class="type-badge {{ event_type }}">{{ event_type }}</span>
                    <span class="type-count">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="section-card">
            <h2>Detections by Model</h2>
            <div class="model-breakdown">
                {% for model, count in stats.detections_by_model.items() %}
                <div class="model-item">
                    <span class="model-badge {{ model }}">{{ model }}</span>
                    <span class="model-count">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Recent Alerts -->
    <div class="section-card full-width">
        <div class="section-header">
            <h2>Recent Alerts</h2>
            <a href="/alerts" class="btn btn-secondary">View All</a>
        </div>
        <div class="alerts-table-container" id="recent-alerts">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Severity</th>
                        <th>Model</th>
                        <th>Label</th>
                        <th>Device</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in detections %}
                    <tr class="severity-row-{{ d.severity|lower }}">
                        <td class="timestamp">{{ d.ts[:19] }}</td>
                        <td><span class="severity-badge {{ d.severity|lower }}">{{ d.severity }}</span></td>
                        <td><span class="model-badge {{ d.model_name }}">{{ d.model_name }}</span></td>
                        <td class="label-cell" title="{{ d.label }}">{{ d.label[:50] }}{% if d.label|length > 50 %}...{%
                            endif %}</td>
                        <td>{{ d.device_id }}</td>
                        <td>{{ "%.2f"|format(d.score) }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="empty-state">No recent alerts</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    (() => {
        'use strict';

        const bars = document.querySelectorAll('.severity-bar[data-width]');
        for (const el of bars) {
            const w = Number.parseFloat(el.dataset.width || '0');
            // Clamp 0..100 to avoid layout weirdness
            const clamped = Number.isFinite(w) ? Math.max(0, Math.min(100, w)) : 0;
            el.style.width = `${clamped}%`;
        }
    })();
</script>

{% endblock %}